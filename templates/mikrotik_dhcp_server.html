{% extends "layout.html" %}

{% block title %}DHCP Server - MikroTik Pro{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold">DHCP Server List</h2>
    <div class="d-flex gap-2">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#dhcpSetupModal">
            <i class="fas fa-magic me-1"></i> DHCP Setup
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDhcpModal">
            <i class="fas fa-plus me-1"></i> Add Server
        </button>
    </div>
</div>

<div class="card border-0 shadow-sm overflow-hidden">
    <table class="table table-hover mb-0">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Interface</th>
                <th>Network Address</th>
                <th>IP Pool Range</th>
                <th>DNS Server IPs</th>
                <th>Status</th>
                <th class="text-center">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for srv in servers %}
            <tr>
                <td><strong>{{ srv['name'] }}</strong></td>
                <td><span class="badge bg-light text-dark border">{{ srv['interface'] }}</span></td>
                <td><code>{{ srv['network'] }}</code></td>
                <td><span class="text-primary fw-bold">{{ srv['ip_range'] }}</span></td>
                <td>
                    {% if srv['dns'] %}
                        {% for ip in srv['dns'].split(',') %}
                            <span class="badge bg-info text-dark shadow-sm" style="font-size: 0.7rem;">
                                <i class="fas fa-network-wired me-1"></i>{{ ip.strip() }}
                            </span>
                        {% endfor %}
                    {% else %}
                        <span class="text-danger small"><i class="fas fa-exclamation-triangle me-1"></i>No DNS Set</span>
                    {% endif %}
                </td>
                <td>
                    {% if srv['disabled'] == 'false' or srv['disabled'] == False or srv['disabled'] == 'no' %}
                        <span class="badge bg-success">Active</span>
                    {% else %}
                        <span class="badge bg-danger">Disabled</span>
                    {% endif %}
                </td>
                <td class="text-center">
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-sm btn-outline-info" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editDhcpModal" 
                                onclick="populateDhcpModal('{{ srv['.id'] }}', '{{ srv['name'] }}', '{{ srv['interface'] }}', '{{ srv['pool_name'] }}')">
                            <i class="fas fa-edit"></i>
                        </button>

                        <a href="{{ url_for('delete_dhcp_server', id=srv['.id']) }}" 
                           class="btn btn-sm btn-outline-danger" 
                           onclick="return confirm('Are you sure?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>

                <div class="modal fade" id="editDhcpModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-info text-white">
                                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit DHCP Server</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form action="/mikrotik/networks/dhcp-server/edit" method="POST">
                                <div class="modal-body">
                                    <input type="hidden" name="server_id" id="edit_srv_id">
                                    <div class="mb-3">
                                        <label class="form-label">Server Name</label>
                                        <input type="text" name="name" id="edit_srv_name" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Interface</label>
                                        <select name="interface" id="edit_srv_interface" class="form-select" required>
                                            {% for iface in interfaces %}
                                                <option value="{{ iface['name'] }}">{{ iface['name'] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Address Pool</label>
                                        <select name="pool" id="edit_srv_pool" class="form-select" required>
                                            <option value="static-only">static-only</option>
                                            {% for pool in pools %}
                                                <option value="{{ pool['name'] }}">{{ pool['name'] }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-info text-white">Update Server</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="addDhcpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New DHCP Server (Manual)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/mikrotik/networks/dhcp-server/add" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Server Name</label>
                        <input type="text" name="name" class="form-control" placeholder="dhcp1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Interface</label>
                        <select name="interface" class="form-select" required>
                            {% for iface in interfaces %}
                                <option value="{{ iface['name'] }}">{{ iface['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address Pool</label>
                        <select name="pool" class="form-select" required>
                            <option value="static-only">static-only</option>
                            {% for pool in pools %}
                                <option value="{{ pool['name'] }}">{{ pool['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Server</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="dhcpSetupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-magic me-2"></i>DHCP Setup Wizard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/mikrotik/networks/dhcp-server/setup" method="POST">
                <div class="modal-body">
                    <p class="small text-muted">This wizard will create a Pool, Network, and Server automatically.</p>
                    <div class="mb-3">
                        <label class="form-label">Select Interface</label>
                        <select name="interface" class="form-select" required>
                            {% for iface in interfaces %}
                                <option value="{{ iface['name'] }}">{{ iface['name'] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IP Range for Pool</label>
                        <input type="text" name="ip_range" class="form-control" placeholder="192.168.88.10-192.168.88.254" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gateway IP</label>
                        <input type="text" name="gateway" class="form-control" placeholder="192.168.88.1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">DNS Servers</label>
                        <input type="text" name="dns" class="form-control" value="8.8.8.8,1.1.1.1">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Finish Setup</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    function populateDhcpModal(id, name, interface, pool) {
        document.getElementById('edit_srv_id').value = id;
        document.getElementById('edit_srv_name').value = name;
        document.getElementById('edit_srv_interface').value = interface;
        document.getElementById('edit_srv_pool').value = pool;
    }
</script>
{% endblock %}